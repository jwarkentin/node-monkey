require("source-map-support").install(),function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NodeMonkey=t():e.NodeMonkey=t()}(global,(function(){return(()=>{"use strict";var __webpack_modules__={91:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>__WEBPACK_DEFAULT_EXPORT__});var _babel_runtime_helpers_typeof__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(727),_babel_runtime_helpers_typeof__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_babel_runtime_helpers_typeof__WEBPACK_IMPORTED_MODULE_0__),origJSON=global.JSON,JSON={};const __WEBPACK_DEFAULT_EXPORT__=JSON;"function"!=typeof JSON.decycle&&(JSON.decycle=function(e,t){var r=[],n=[];return function e(i,o){var s,a;return void 0!==t&&(i=t(i)),"object"!==_babel_runtime_helpers_typeof__WEBPACK_IMPORTED_MODULE_0___default()(i)||null===i||i instanceof Boolean||i instanceof Date||i instanceof Number||i instanceof RegExp||i instanceof String?i:(s=r.indexOf(i))>=0?{$ref:n[s]}:(r.push(i),n.push(o),Array.isArray(i)?(a=[],i.forEach((function(t,r){a[r]=e(t,o+"["+r+"]")}))):(a={},Object.keys(i).forEach((function(t){a[t]=e(i[t],o+"["+JSON.stringify(t)+"]")}))),a)}(e,"$")}),"function"!=typeof JSON.retrocycle&&(JSON.retrocycle=function retrocycle($){var px=/^\$(?:\[(?:\d+|\"(?:[^\\\"\u0000-\u001f]|\\([\\\"\/bfnrt]|u[0-9a-zA-Z]{4}))*\")\])*$/;return function rez(value){value&&"object"===_babel_runtime_helpers_typeof__WEBPACK_IMPORTED_MODULE_0___default()(value)&&(Array.isArray(value)?value.forEach((function(element,i){if("object"===_babel_runtime_helpers_typeof__WEBPACK_IMPORTED_MODULE_0___default()(element)&&null!==element){var path=element.$ref;"string"==typeof path&&px.test(path)?value[i]=eval(path):rez(element)}})):Object.keys(value).forEach((function(name){var item=value[name];if("object"===_babel_runtime_helpers_typeof__WEBPACK_IMPORTED_MODULE_0___default()(item)&&null!==item){var path=item.$ref;"string"==typeof path&&px.test(path)?value[name]=eval(path):rez(item)}})))}($),$}),JSON=origJSON},727:e=>{e.exports=require("@babel/runtime/helpers/typeof")}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var r=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](r,r.exports,__webpack_require__),r.exports}__webpack_require__.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return __webpack_require__.d(t,{a:t}),t},__webpack_require__.d=(e,t)=>{for(var r in t)__webpack_require__.o(t,r)&&!__webpack_require__.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var __webpack_exports__={};return(()=>{__webpack_require__.d(__webpack_exports__,{default:()=>fe});const e=require("@babel/runtime/helpers/asyncToGenerator");var t=__webpack_require__.n(e);const r=require("@babel/runtime/helpers/classCallCheck");var n=__webpack_require__.n(r);const i=require("@babel/runtime/helpers/createClass");var o=__webpack_require__.n(i);const s=require("@babel/runtime/helpers/defineProperty");var a=__webpack_require__.n(s);const u=require("@babel/runtime/regenerator");var c=__webpack_require__.n(u);const l=require("os");var p=__webpack_require__.n(l);const h=require("fs");var f=__webpack_require__.n(h);const _=require("path");var d=__webpack_require__.n(_);const m=require("events"),v=require("lodash");var y=__webpack_require__.n(v);const w=require("keypair");var b=__webpack_require__.n(w),g=__webpack_require__(91),k=__webpack_require__(727),S=__webpack_require__.n(k);const C={isObject:function(e){var t=S()(e);return!!e&&("object"==t||"function"==t)},invert:function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(t[e[r]]=r);return t}},x=require("source-map-support");var M=__webpack_require__.n(x);const O=Object.assign({parseCommand:function(e){var t,r=/"(.*?)"|'(.*?)'|`(.*?)`|([^\s"]+)/gi,n=[];do{null!==(t=r.exec(e))&&n.push(t[1]||t[2]||t[3]||t[4])}while(null!==t);return n},getStack:function(){var e=Error.prepareStackTrace,t=Error.stackTraceLimit;Error.prepareStackTrace=function(e,t){return t.map(M().wrapCallSite)},Error.stackTraceLimit=30;var r=(new Error).stack;return Error.prepareStackTrace=e,Error.stackTraceLimit=t,r.slice(1)},getPromiseObj:function(){var e={};return e.promise=new Promise((function(t,r){Object.assign(e,{resolve:t,reject:r})})),e}},C);var E={trace:10,debug:20,info:30,warn:40,error:50,fatal:60},N=O.invert(E);const A=require("restify");var q=__webpack_require__.n(A);const P=require("restify-cors-middleware");var j=__webpack_require__.n(P);const T=require("socket.io");var I=__webpack_require__.n(T);const F=function e(t,r,i,o,s){n()(this,e),a()(this,"commandManager",null),a()(this,"write",(function(e,t){console.log(e)})),a()(this,"writeLn",(function(e,t){console.log(e)})),a()(this,"error",(function(e,t){console.error(e)})),a()(this,"prompt",(function(e,t,r){"function"==typeof t&&(t,t=void 0),t||(t={}),console.warn("Prompt not implemented")})),this.commandManager=t,this.write=r,this.writeLn=i,this.error=o,this.prompt=s},L=function(e){var t=I()();t.attach(e.server,{autoUnref:!0});var r=t.of("/nm");return r.on("connection",(function(t){var r=null;t.emit("settings",e.clientSettings),t.emit("auth"),t.on("auth",(function(r){e.userManager.verifyUser(r.username,r.password).then((function(n){t.emit("authResponse",n,n?void 0:"Incorrect password"),n&&(t.username=r.username,t.join("authed"),e.onAuth&&e.onAuth(t))})).catch((function(e){t.emit("authResponse",!1,e)}))})),t.on("cmd",(function(n,i){t.username?(r||(r=function(e,t){var r=0,n={},i=function(e,r){e&&t.emit("console",{method:"log",args:[e]})},o=function(e,r){e&&t.emit("console",{method:"error",args:[e]})},s=function(e,i,o){"function"==typeof i&&(o=i,i=void 0),i||(i={});var s=r++;t.emit("prompt",s,e,i),n[s]=o};return t.on("promptResponse",(function(e,t){n[e]&&n[e](null,t)})),new F(e,i,i,o,s)}(e.cmdManager,t)),e.cmdManager.runCmd(i,t.username,r).then((function(e){t.emit("cmdResponse",n,null,e)})).catch((function(e){t.emit("cmdResponse",n,e&&e.message||e,null)}))):t.emit("cmdResponse",n,"You are not authorized to run commands")}))})),y().each(e.handlers,(function(e,r){t.on(r,e)})),r};const D=require("tty");var U=__webpack_require__.n(D);const R=require("node-pty"),B=require("ssh2");var H=__webpack_require__.n(B);const K=require("terminal-kit");var z=__webpack_require__.n(K);function J(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return W(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return W(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function W(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var $=function(){function e(t){n()(this,e),a()(this,"options",{host:"127.0.0.1",port:50501,title:"Node Monkey",prompt:"Node Monkey:",silent:!1}),a()(this,"server",void 0),a()(this,"clients",new Set),t=Object.assign(this.options,t),this.server=new(H().Server)({hostKeys:t.hostKeys.map((function(e){return f().readFileSync(e)}))},this.onClient.bind(this));var r=this.options.monkey;this.server.listen(t.port,t.host,(function(){t.silent||r.local.log("SSH listening on ".concat(this.address().port))}))}return o()(e,[{key:"shutdown",value:function(){var e,t=J(this.clients);try{for(t.s();!(e=t.n()).done;){var r=e.value;r.write("\nShutting down"),r.close()}}catch(e){t.e(e)}finally{t.f()}}},{key:"onClient",value:function(e){var t=this,r=this.options,n=r.cmdManager,i=r.userManager,o=r.title,s=r.prompt;this.clients.add(new V({client:e,cmdManager:n,userManager:i,title:o,prompt:s,onClose:function(){return t.clients.delete(e)}}))}}]),e}(),V=function(){function e(t){n()(this,e),this.options=t,this.client=t.client,this.cmdInterface=null,this.userManager=t.userManager,this.session=null,this.stream=null,this.pty=null,this.term=null,this.ptyInfo=null,this.title=t.title,this.promptTxt="".concat(t.prompt," "),this.inputActive=!1,this.cmdHistory=[],this.username=null,this.client.on("authentication",this.onAuth.bind(this)),this.client.on("ready",this.onReady.bind(this)),this.client.on("end",this.onClose.bind(this))}return o()(e,[{key:"_initCmdMan",value:function(){var e=this,t=function(t,r){r||(r={}),t||(t=""),r.bold?e.term.bold(t):e.term(t),r.newline&&e.term.nextLine()};this.cmdInterface=new F(this.options.cmdManager,t,(function(e,r){r||(r={}),r.newline=!0,t(e,r)}),(function(t,r){r||(r={}),e.term.red(t),r.newline&&e.term.nextLine()}),(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;"function"==typeof r&&(n=r,r=void 0),r||(r={});var i={};r.hideInput&&(i.echo=!1),e.term(t),e.term.inputField(i,n)}))}},{key:"write",value:function(e,t){var r=t.style,n=void 0===r?void 0:r;this.term&&(n?this.term[n](e):this.term(e))}},{key:"close",value:function(){this.stream&&this.stream.end(),this.onClose()}},{key:"onAuth",value:function(e){var t=this;"password"==e.method?this.userManager.verifyUser(e.username,e.password).then((function(r){r?(t.username=e.username,e.accept()):e.reject()})).catch((function(t){e.reject()})):(e.method,e.reject())}},{key:"onReady",value:function(){var e=this;this.client.on("session",(function(t,r){e.session=t(),e.session.once("pty",(function(t,r,n){e.ptyInfo=n,t&&t()})).on("window-change",(function(t,r,n){Object.assign(e.ptyInfo,n),e._resize(),t&&t()})).once("shell",(function(t,r){e.stream=t(),e._initCmdMan(),e._initStream(),e._initPty(),e._initTerm()}))}))}},{key:"onClose",value:function(){var e=this.options.onClose;e&&e()}},{key:"onKey",value:function(e,t,r){var n=this;if("CTRL_L"===e)this.clearScreen();else if("CTRL_C"===e)this.inputActive=!1,this.inputField.abort(),this.term("\n^^C\n"),this.prompt();else if("CTRL_D"===e){this.inputField.getInput().length||(this.term.nextLine(),setTimeout((function(){n.close()}),0))}}},{key:"_resize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this,t=e.term;t&&t.stdout.emit("resize")}},{key:"_initStream",value:function(){var e=this.stream;e.name=this.title,e.isTTY=!0,e.setRawMode=function(){},e.on("error",(function(e){console.error("SSH stream error:",e.message)}))}},{key:"_initPty",value:function(){var e=this,t=R.native.open(this.ptyInfo.cols,this.ptyInfo.rows);this.pty={master_fd:t.master,slave_fd:t.slave,master:new(U().WriteStream)(t.master),slave:new(U().ReadStream)(t.slave)},Object.defineProperty(this.pty.slave,"columns",{enumerable:!0,get:function(){return e.ptyInfo.cols}}),Object.defineProperty(this.pty.slave,"rows",{enumerable:!0,get:function(){return e.ptyInfo.rows}}),this.stream.stdin.pipe(this.pty.master),this.pty.master.pipe(this.stream.stdout)}},{key:"_initTerm",value:function(){var e=this.term=z().createTerminal({stdin:this.pty.slave,stdout:this.pty.slave,stderr:this.pty.slave,generic:this.ptyInfo.term,appName:this.title,isSSH:!0,isTTY:!0});e.on("key",this.onKey.bind(this)),e.windowTitle(this._interpolate(this.title)),this.clearScreen()}},{key:"_interpolate",value:function(e){for(var t,r=/{@(.+?)}/g,n={username:this.username};t=r.exec(e);)n[t[1]]&&(e=e.replace(t[0],n[t[1]]));return e}},{key:"clearScreen",value:function(){this.term.clear(),this.prompt()}},{key:"prompt",value:function(){var e=this,t=this.term;t.windowTitle(this._interpolate(this.title)),t.bold(this._interpolate(this.promptTxt)),this.inputActive||(this.inputActive=!0,this.inputField=t.inputField({history:this.cmdHistory,autoComplete:Object.keys(this.options.cmdManager.commands),autoCompleteHint:!0,autoCompleteMenu:!0},(function(r,n){return e.inputActive=!1,t.nextLine(),r?t.error(r.message||r):n?(" "!==n[0]&&e.cmdHistory.push(n),void("exit"===n?setTimeout(e.close.bind(e)):"clear"===n?e.clearScreen():n?e.options.cmdManager.runCmd(n,e.username,e.cmdInterface).then((function(t){"string"!=typeof t&&(t=JSON.stringify(t,null,"  ")),e.term(t),e.term.nextLine(),e.prompt()})).catch((function(t){"string"!=typeof t&&(t=t.message||JSON.stringify(t,null,"  ")),e.term.red.error(t),e.term.nextLine(),e.prompt()})):e.prompt())):e.prompt()})))}}]),e}();const Z=$,Y=require("minimist");var X=__webpack_require__.n(Y);const G=function e(){var r=this;n()(this,e),a()(this,"commands",{}),a()(this,"addCmd",(function(e,t,n){if(r.commands[e])throw new Error("'".concat(e,"' is already registered as a command"));"function"==typeof t&&(n=t,t={}),r.commands[e]={opts:t,exec:n}})),a()(this,"runCmd",function(){var e=t()(c().mark((function e(t,n,i){var o,s,a,u,l,p;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=O.parseCommand(t),s=o[0],a=r.commands[s],n){e.next=5;break}throw new Error("Missing user context for command '".concat(s,"'"));case 5:if(a){e.next=7;break}throw new Error("Command not found: '".concat(s,"'"));case 7:return u=X()(o.slice(1)),l=O.getPromiseObj(),p=a.exec({args:u,username:n},{write:i.write,writeLn:i.writeLn,error:i.error,prompt:i.prompt},l.resolve),e.abrupt("return",p.then?p:l.promise);case 11:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}())},Q=require("scrypt-kdf");var ee=__webpack_require__.n(Q);const te=function(){function e(t){n()(this,e),a()(this,"userFile",void 0),a()(this,"userFileCache",null),a()(this,"userFileCreated",!1),this.userFile=t.userFile,t.silent||this.getUsers().then((function(e){var t=Object.keys(e);t.length?1===t.length&&"guest"===t[0]&&console.warn("[WARN] No users detected. You can login with default user 'guest' and password 'guest' when prompted.\nThis user will be disabled when you create a user account.\n"):"production"===process.env.NODE_ENV?console.warn("No users have been created and you are running in production mode so you will not be able to login.\n"):console.warn("It seems there are no users and you are not running in production mode so you will not be able to login. This is probably a bug. Please report it!\n")}))}var r,i,s,u,l,p,h,_;return o()(e,[{key:"getUsers",value:(_=t()(c().mark((function e(){var t,r=this;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.userFileCache){e.next=2;break}return e.abrupt("return",this.userFileCache);case 2:if(e.prev=2,this.userFile){e.next=7;break}throw(t=new Error("No user file specified")).code="ENOENT",t;case 7:return this.userFileCache=JSON.parse(f().readFileSync(this.userFile).toString("base64")),this.userFileCreated=!0,setTimeout((function(){r.userFileCache=null}),5e3),e.abrupt("return",this.userFileCache);case 13:if(e.prev=13,e.t0=e.catch(2),"ENOENT"!==e.t0.code){e.next=17;break}return e.abrupt("return","production"===process.env.NODE_ENV?{}:{guest:{password:"c2NyeXB0AA8AAAAIAAAAAc8D4r96lep3aBQSBeAqf0a+9MX6KyB6zKTF9Nk3ruTPIXrzy8IM7vjSLpIKuVZMNTZZ72CMqKp/PQmnyXmf7wGup1bWBGSwoV5ymA72ZzZg"}});case 17:throw e.t0;case 18:case"end":return e.stop()}}),e,this,[[2,13]])}))),function(){return _.apply(this,arguments)})},{key:"_writeFile",value:function(e){this.userFileCache=null,f().writeFileSync(this.userFile,JSON.stringify(e,null,"  ")),this.userFileCreated=!0}},{key:"_hashPassword",value:(h=t()(c().mark((function e(t){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ee().kdf(t,{logN:15,r:8,p:1});case 2:return e.abrupt("return",e.sent.toString("base64"));case 3:case"end":return e.stop()}}),e)}))),function(e){return h.apply(this,arguments)})},{key:"_verifyPassword",value:(p=t()(c().mark((function e(t,r){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",ee().verify(Buffer.from(t,"base64"),r));case 1:case"end":return e.stop()}}),e)}))),function(e,t){return p.apply(this,arguments)})},{key:"createUser",value:(l=t()(c().mark((function e(t,r){var n;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.userFile){e.next=2;break}throw new Error("No user file found. Did you forget to set the 'dataDir' option?");case 2:return e.next=4,this.getUsers();case 4:if(!(n=e.sent)[t]){e.next=7;break}throw new Error("User '".concat(t,"' already exists"));case 7:return this.userFileCreated||delete n.guest,e.next=10,this._hashPassword(r);case 10:e.t0=e.sent,n[t]={password:e.t0},this._writeFile(n);case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return l.apply(this,arguments)})},{key:"deleteUser",value:(u=t()(c().mark((function e(t){var r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.userFile){e.next=2;break}throw new Error("No user file found. Did you forget to set the 'dataDir' option?");case 2:return e.next=4,this.getUsers();case 4:if((r=e.sent)[t]){e.next=7;break}throw new Error("User '".concat(t,"' does not exist"));case 7:if(this.userFileCreated){e.next=9;break}throw new Error("User file has not been created");case 9:delete r[t],this._writeFile(r);case 11:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"setPassword",value:(s=t()(c().mark((function e(t,r){var n;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.userFile){e.next=2;break}throw new Error("No user file found. Did you forget to set the 'dataDir' option?");case 2:return e.next=4,this.getUsers();case 4:return n=e.sent,e.next=7,this._hashPassword(r);case 7:n[t].password=e.sent,this._writeFile(n);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"getUserData",value:(i=t()(c().mark((function e(t){var r;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getUsers();case 2:if((r=e.sent)[t]){e.next=5;break}throw new Error("User '".concat(t,"' does not exist"));case 5:return e.abrupt("return",r[t]);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"verifyUser",value:(r=t()(c().mark((function e(t,r){var n;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getUserData(t);case 2:return n=e.sent,e.abrupt("return",this._verifyPassword(n.password,r));case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})}]),e}();function re(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return ne(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return ne(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function ne(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var ie=process.env.NODE_ENV,oe=50500,se=y().mapValues(console),ae=new m.EventEmitter,ue=["log","info","warn","error","dir"],ce=0,le=function(){function e(t){var r;n()(this,e),a()(this,"msgBuffer",[]),a()(this,"BUNYAN_STREAM",(r=this,{write:function(e){e=JSON.parse(e),r._sendMessage({method:N[e.level]||"info",args:[e.msg,e]})}})),a()(this,"_attached",!1),a()(this,"_typeHandlers",{});var i=this.options=y().merge({server:{server:null,host:"0.0.0.0",port:oe,silent:!1,bufferSize:50,attachOnStart:!0,disableLocalOutput:!1},client:{showCallerInfo:"production"!==ie,convertStyles:!0},ssh:{enabled:!1,host:"0.0.0.0",port:50501,title:"Node Monkey on ".concat(p().hostname()),prompt:"[Node Monkey] {@username}@".concat(p().hostname(),":")},dataDir:null},t);this._createLocal(),this._createRemote(),this._setupCmdMan(),this._setupUserManager(),this._setupServer(),this._setupSSH(),i.server.attachOnStart&&this.attachConsole(),console.local=y().mapValues(this.local,(function(e,t){var r=function(){return e.apply(void 0,arguments)};return Object.defineProperty(r,"name",{value:t}),r})),console.remote=y().mapValues(this.remote,(function(e,t){var r=function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return e.apply(void 0,[{callerStackDistance:2}].concat(r))};return Object.defineProperty(r,"name",{value:t}),r}))}return o()(e,[{key:"_getServerProtocol",value:function(e){return e._events&&e._events.tlsClientError?"https":"http"}},{key:"getServerPaths",value:function(){return{basePath:d().normalize("".concat(__dirname,"/../dist")),client:"monkey.js",index:"index.html"}}},{key:"_displayServerWelcome",value:function(){if(!this.options.server.silent){var e=this.options.server.server;if(e.listening){var t=this._getServerProtocol(e),r=e.address(),n=r.address,i=r.port;this.local.log("Node Monkey listening at ".concat(t,"://").concat(n,":").concat(i))}else e.on("listening",this._displayServerWelcome.bind(this))}}},{key:"_setupCmdMan",value:function(){this._cmdMan=new G({write:function(e,t){console.log(e)},writeLn:function(e,t){console.log(e)},error:function(e,t){console.error(e)},prompt:function(e,t,r){"function"==typeof t&&(t,t=void 0),t||(t={}),console.warn("Prompt not implemented")}}),this.addCmd=this._cmdMan.addCmd,this.runCmd=this._cmdMan.runCmd}},{key:"_setupUserManager",value:function(){var e=this.options.dataDir,r=this.userManager=new te({userFile:e?"".concat(e,"/users.json"):void 0,silent:this.options.server.silent});this.addCmd("showusers",function(){var e=t()(c().mark((function e(t,n){var i;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.getUsers();case 2:i=e.sent,n.writeLn(Object.keys(i).join("\n"));case 4:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()),this.addCmd("adduser",(function(e,t,n){var i=e.args._[0];if(!i)return t.error("You must specify a username"),n();t.prompt("Password: ",{hideInput:!0},(function(e,o){t.writeLn(),t.prompt("Again: ",{hideInput:!0},(function(e,s){t.writeLn(),o===s?r.createUser(i,o).then((function(){return t.write("Created user '".concat(i,"'"))})).catch(t.error).then(n):(t.error("Passwords do not match"),n())}))}))})),this.addCmd("deluser",(function(e,t,n){var i=e.args._[0];if(!i)return t.error("You must specify a username"),n();r.deleteUser(i).then((function(){return t.write("Deleted user '".concat(i,"'"))})).catch(t.error).then(n)})),this.addCmd("passwd",(function(e,t,n){e.args;var i=e.username;t.prompt("Current password: ",{hideInput:!0},(function(e,o){t.writeLn(),r.verifyUser(i,o).then((function(e){e?t.prompt("Password: ",{hideInput:!0},(function(e,o){t.writeLn(),t.prompt("Again: ",{hideInput:!0},(function(e,s){t.writeLn(),o===s?r.setPassword(i,o).then((function(){return t.write("Updated password for ".concat(i))})).catch(t.error).then(n):(t.error("Passwords do not match"),n())}))})):(t.error("Incorrect password"),n())}))}))}))}},{key:"_setupServer",value:function(){var e=this.options,t=e.server.server;if(!t){var r=function(e){var t=q().createServer(),r=j()({origins:[/https?:\/\/.+/],allowHeaders:[],exposeHeaders:[],credentials:!0});return t.pre(q().pre.userAgentConnection()),t.pre(r.preflight),t.use(q().plugins.gzipResponse()),t.use(r.actual),t.get("*",q().plugins.serveStatic({directory:__dirname,default:"index.html"})),t}();t=this.options.server.server=r.server;var n=e.server,i=n.host,o=n.port;r.listen(o,i)}this._displayServerWelcome(),this.serverApp=t,this.remoteClients=L({server:t.server||t,cmdManager:this._cmdMan,userManager:this.userManager,onAuth:this._sendMessages.bind(this),clientSettings:e.client})}},{key:"_setupSSH",value:function(){var e=this.options.ssh;if(e.enabled){var t=this.options.dataDir;if(!t)throw new Error("Options 'dataDir' is required to enable SSH");var r,n=/\.key$/,i=[],o=re(f().readdirSync(t));try{for(o.s();!(r=o.n()).done;){var s=r.value;n.test(s)&&i.push("".concat(t,"/").concat(s))}}catch(e){o.e(e)}finally{o.f()}if(!i.length){console.log("No SSH host key found. Generating new host key...");var a=b()();f().writeFileSync("".concat(t,"/rsa.key"),a.private),f().writeFileSync("".concat(t,"/rsa.key.pub"),a.public),i=["".concat(t,"/rsa.key")]}this.SSHMan=new Z({monkey:this,userManager:this.userManager,cmdManager:this._cmdMan,silent:this.options.server.silent,host:e.host,port:e.port,title:y().result(e,"title"),prompt:y().result(e,"prompt"),hostKeys:i})}}},{key:"_getCallerInfo",value:function(e){if(this.options.client.showCallerInfo){var t=O.getStack().map((function(e){return{functionName:e.getFunctionName(),methodName:e.getMethodName(),fileName:e.getFileName(),lineNumber:e.getLineNumber(),columnNumber:e.getColumnNumber()}})),r=t.find((function(e,t,r){var n=r[t-2],i=r[t-4];return!(!n||"Logger._emit"!==n.functionName||!/\/bunyan\.js$/.test(n.fileName))||(!(!n||!i||"emit"!==n.methodName||"_sendMessage"!==i.methodName)||void 0)}));if(r||"number"!=typeof e||(r=t[e]),r)return{caller:r.functionName||r.methodName,file:r.fileName,line:r.lineNumber,column:r.columnNumber}}}},{key:"_sendMessage",value:function(e,t){this.msgBuffer.push({method:e.method,args:e.args,callerInfo:e.callerInfo||this._getCallerInfo(t+1)}),this.msgBuffer.length>this.options.server.bufferSize&&this.msgBuffer.shift(),this._sendMessages()}},{key:"_sendMessages",value:function(){var e=this.remoteClients;y().size(e.adapter.rooms.get("authed"))&&(y().each(this.msgBuffer,(function(t){e.to("authed").emit("console",g.Z.decycle(t))})),this.msgBuffer=[])}},{key:"_createLocal",value:function(){this.local=se}},{key:"_createRemote",value:function(){var e=this,t=this.remote={};ue.forEach((function(r){e.remote[r]=function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var o=n[0]&&n[0].callerStackDistance;e._sendMessage({method:r,args:o?n.slice(1):n},o?o+1:2)},Object.defineProperty(t[r],"name",{value:r})}))}},{key:"attachConsole",value:function(e){var t=this;if(!this._attached){if(!ce){var r=0;ue.forEach((function(e){console[e]=function(){for(var n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];var s;if(r)return(s=t.local)[e].apply(s,i);++r,ae.emit.apply(ae,[e].concat(i)),--r},Object.defineProperty(console[e],"name",{value:e})}))}++ce;var n=this.options.server;e=void 0!==e?e:n.disableLocalOutput,y().each(this.remote,(function(r,n){var i=t._typeHandlers[n]=function(){for(var i=arguments.length,o=new Array(i),s=0;s<i;s++)o[s]=arguments[s];var a;(r.apply(void 0,[{callerStackDistance:4}].concat(o)),e)||(a=t.local)[n].apply(a,o)};Object.defineProperty(i,"name",{value:n}),ae.on(n,i)})),this._attached=!0}}},{key:"detachConsole",value:function(){var e=this;Object.assign(console,this.local),this._attached=!1,--ce,ue.forEach((function(t){ae.removeListener(t,e._typeHandlers[t]),delete e._typeHandlers[t]}))}}]),e}(),pe={},he=50499;function fe(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";if("string"==typeof e&&(t=e,e=void 0),!pe[t]){e||(e={});var r=y().get(e,"server.port");r?he=+r:(y().set(e,"server.port",++he),y().set(e,"ssh.port",++he)),pe[t]=new le(e)}return pe[t]}})(),__webpack_exports__=__webpack_exports__.default,__webpack_exports__})()}));
//# sourceMappingURL=server.js.map